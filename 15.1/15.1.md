# Домашнее задание к занятию «Организация сети»

### Подготовка к выполнению задания

1. Домашнее задание состоит из обязательной части, которую нужно выполнить на провайдере Yandex Cloud, и дополнительной части в AWS (выполняется по желанию). 
2. Все домашние задания в блоке 15 связаны друг с другом и в конце представляют пример законченной инфраструктуры.  
3. Все задания нужно выполнить с помощью Terraform. Результатом выполненного домашнего задания будет код в репозитории. 
4. Перед началом работы настройте доступ к облачным ресурсам из Terraform, используя материалы прошлых лекций и домашнее задание по теме «Облачные провайдеры и синтаксис Terraform». Заранее выберите регион (в случае AWS) и зону.

---
### Задание 1. Yandex Cloud 

**Что нужно сделать**

1. Создать пустую VPC. Выбрать зону.
2. Публичная подсеть.

 - Создать в VPC subnet с названием public, сетью 192.168.10.0/24.
 - Создать в этой подсети NAT-инстанс, присвоив ему адрес 192.168.10.254. В качестве image_id использовать fd80mrhj8fl2oe87o4e1.
 - Создать в этой публичной подсети виртуалку с публичным IP, подключиться к ней и убедиться, что есть доступ к интернету.
3. Приватная подсеть.
 - Создать в VPC subnet с названием private, сетью 192.168.20.0/24.
 - Создать route table. Добавить статический маршрут, направляющий весь исходящий трафик private сети в NAT-инстанс.
 - Создать в этой приватной подсети виртуалку с внутренним IP, подключиться к ней через виртуалку, созданную ранее, и убедиться, что есть доступ к интернету.

Resource Terraform для Yandex Cloud:

- [VPC subnet](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/vpc_subnet).
- [Route table](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/vpc_route_table).
- [Compute Instance](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/compute_instance).

---
### Решение
Вся конфигурация terraform прописана в [main](https://github.com/AlekseyDrobnyi/netology_devops/blob/main/15.1/.tf/main.tf) [vars](https://github.com/AlekseyDrobnyi/netology_devops/blob/main/15.1/.tf/vars.tf) [version](https://github.com/AlekseyDrobnyi/netology_devops/blob/main/15.1/.tf/version.tf)  

Запускаю проверку и применение плана
```bash
ubuntu@ubuntu-VirtualBox:~/cloud-terraform$ terraform validate
Success! The configuration is valid.

ubuntu@ubuntu-VirtualBox:~/cloud-terraform$ terraform apply -auto-approve

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # yandex_compute_instance.nat-instance will be created
  + resource "yandex_compute_instance" "nat-instance" {
      + created_at                = (known after apply)
      + folder_id                 = (known after apply)
      + fqdn                      = (known after apply)
      + gpu_cluster_id            = (known after apply)
      + hostname                  = "nat-instance"
      + id                        = (known after apply)
      + metadata                  = {
          + "ssh-keys" = <<-EOT
                ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDGYE1R1KFmX/wdGVdIAYbpt8PjRckEX0fdw5tETRsSulQfx1iMJQ4w6/E0aljckd4SJDf0y07i9gs8HOV5xbYwezmL3d9reKldlvLRXbatlDMSZcqyFGJXsKci07dIH211lte3petVf2vEXt9KanGwygLfZVQAnAEY+l02zwBSYxBHYdDHyNAhnjG886ilbkV7EgJinMABU5RXFcTPAUgZIFiuNuBGvql065KkR3Li4QbCM1O220go6SyYc9gg+PUlW1bNu6bauqnZqPGgjH+etcDkm0BAbyRp/g43ljxJZC+fqKJoSSXfe79NRpzSSyFvuaUo4n37pxOuc8OWow7I2RWNeVqVHTkfNfMxdGzp3S8xRTi0+EDROFiAARfXEYnAb+yOSgkU/r0YUgAZXYqs9GOaj1QVQbhJaNKl9WhtsSTPzPRQLXT1JpK4h6owKF2oTmq/Ro0yMgQmMvk+0gjY4vmfKi078fF4kxt0Gbb5J2jj0Z6oBzr6eAwarvEVhtU= ubuntu@ubuntu-VirtualBox
            EOT
        }
      + name                      = "nat-instance"
      + network_acceleration_type = "standard"
      + platform_id               = "standard-v1"
      + service_account_id        = (known after apply)
      + status                    = (known after apply)
      + zone                      = "ru-central1-a"
......................
```
На выходе получаю IP адреса машин
```bash
Apply complete! Resources: 7 added, 0 changed, 0 destroyed.

Outputs:

external_ip_address_nat = "84.201.172.23"
external_ip_address_public = "51.250.68.213"
internal_ip_address_private = "192.168.20.10"
```
![image](https://github.com/AlekseyDrobnyi/netology_devops/assets/99823951/2da8dab8-fa4d-416e-8645-e954e264dd8d)

Подключаюсь к `public`-машине и проверяю доступ в сеть
```bash
ubuntu@ubuntu-VirtualBox:~/cloud-terraform$ ssh 51.250.68.213
Warning: Permanently added '51.250.68.213' (ED25519) to the list of known hosts.
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-69-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu May 25 04:59:43 PM UTC 2023
```
```bash
ubuntu@public-instance:~$ ping ya.ru
PING ya.ru (77.88.55.242) 56(84) bytes of data.
64 bytes from ya.ru (77.88.55.242): icmp_seq=1 ttl=251 time=3.85 ms
64 bytes from ya.ru (77.88.55.242): icmp_seq=2 ttl=251 time=3.55 ms
64 bytes from ya.ru (77.88.55.242): icmp_seq=3 ttl=251 time=3.57 ms
64 bytes from ya.ru (77.88.55.242): icmp_seq=4 ttl=251 time=3.49 ms
64 bytes from ya.ru (77.88.55.242): icmp_seq=5 ttl=251 time=3.54 ms
^C
--- ya.ru ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4007ms
rtt min/avg/max/mdev = 3.487/3.597/3.849/0.128 ms
```

![image](https://github.com/AlekseyDrobnyi/netology_devops/assets/99823951/5233f4b7-21cd-4aa6-98eb-62c31e2f618d)

Подключаюсь к `private`-машине и проверяю доступ в сеть. Предварительно добавив id_rsa ключ
```bash
-rw------- 1 ubuntu ubuntu  578 May 25 16:58 authorized_keys
ubuntu@public-instance:~$ nano ~/.ssh/id_rsa
ubuntu@public-instance:~$ chmod 600 ~/.ssh/id_rsa
ubuntu@public-instance:~$ ssh 192.168.20.10
The authenticity of host '192.168.20.10 (192.168.20.10)' can't be established.
ED25519 key fingerprint is SHA256:b5ezF8NGWjRqAbk/ABNxAZNPctpAlQhDFQWdJmOY7H0.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.20.10' (ED25519) to the list of known hosts.
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-69-generic x86_64)
```
```bash
ubuntu@private-instance:~$ ping ya.ru
PING ya.ru (5.255.255.242) 56(84) bytes of data.
64 bytes from ya.ru (5.255.255.242): icmp_seq=1 ttl=249 time=1.82 ms
64 bytes from ya.ru (5.255.255.242): icmp_seq=2 ttl=249 time=0.664 ms
64 bytes from ya.ru (5.255.255.242): icmp_seq=3 ttl=249 time=1.36 ms
64 bytes from ya.ru (5.255.255.242): icmp_seq=4 ttl=249 time=0.743 ms
64 bytes from ya.ru (5.255.255.242): icmp_seq=5 ttl=249 time=0.732 ms
64 bytes from ya.ru (5.255.255.242): icmp_seq=6 ttl=249 time=0.829 ms
^C
--- ya.ru ping statistics ---
6 packets transmitted, 6 received, 0% packet loss, time 5007ms
rtt min/avg/max/mdev = 0.664/1.024/1.816/0.423 ms
```

![image](https://github.com/AlekseyDrobnyi/netology_devops/assets/99823951/0b2c9ae1-218a-4c78-8691-8bacbb00e1a4)

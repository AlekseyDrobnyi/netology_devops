# Домашнее задание к занятию «Хранение в K8s. Часть 1»

### Цель задания

В тестовой среде Kubernetes нужно обеспечить обмен файлами между контейнерам пода и доступ к логам ноды.

------

### Чеклист готовности к домашнему заданию

1. Установленное K8s-решение (например, MicroK8S).
2. Установленный локальный kubectl.
3. Редактор YAML-файлов с подключенным GitHub-репозиторием.

------

### Дополнительные материалы для выполнения задания

1. [Инструкция по установке MicroK8S](https://microk8s.io/docs/getting-started).
2. [Описание Volumes](https://kubernetes.io/docs/concepts/storage/volumes/).
3. [Описание Multitool](https://github.com/wbitt/Network-MultiTool).

------

### Задание 1 

**Что нужно сделать**

Создать Deployment приложения, состоящего из двух контейнеров и обменивающихся данными.

1. Создать Deployment приложения, состоящего из контейнеров busybox и multitool.  
Создал [Deployment](https://github.com/AlekseyDrobnyi/netology_devops/blob/main/13.1/yml/multitool.yaml)  
2. Сделать так, чтобы busybox писал каждые пять секунд в некий файл в общей директории.  
За отправку в файл кажные несколько секунд отвечать будет строка - `command: ['sh', '-c', 'while true; do echo Write! >> /output/file.txt; sleep 10; done']`
3. Обеспечить возможность чтения файла контейнером multitool.
```bash
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl apply -f multitool.yaml
deployment.apps/multitool configured
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl get pod
NAME                         READY   STATUS        RESTARTS   AGE
multitool-845d8cf967-w5qj7   2/2     Running       0          5s

ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitool-845d8cf967-w5qj7 -c busybox -- ls -la /output/
total 12
drwxr-xr-x    2 root     root          4096 Apr  9 07:37 .
drwxr-xr-x    1 root     root          4096 Apr  9 07:37 ..
-rw-r--r--    1 root     root            28 Apr  9 07:38 file.txt
```
Проверяю, что `busybox` пишет в файл
```bash
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitool-845d8cf967-w5qj7 -c busybox -- cat /output/file.txt
Write!
Write!
Write!
Write!
Write!
Write!
```
![image](https://user-images.githubusercontent.com/99823951/230762174-66693ba4-226e-460d-9282-a16c48f1eb35.png)

Так же удостоверяюсь, что `multitool` тоже видит этот же файл
```
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitool-845d8cf967-w5qj7 -c multitool -- ls -la 
total 84
drwxr-xr-x    1 root     root          4096 Apr  9 07:37 .
drwxr-xr-x    1 root     root          4096 Apr  9 07:37 ..
drwxr-xr-x    1 root     root          4096 Dec 19  2021 bin
drwx------    2 root     root          4096 Dec 19  2021 certs
drwxr-xr-x    5 root     root           360 Apr  9 07:37 dev
drwxr-xr-x    1 root     root          4096 Dec 19  2021 docker
drwxr-xr-x    1 root     root          4096 Apr  9 07:37 etc
drwxr-xr-x    2 root     root          4096 Nov 24  2021 home
drwxr-xr-x    1 root     root          4096 Dec 19  2021 lib
drwxr-xr-x    5 root     root          4096 Nov 24  2021 media
drwxr-xr-x    2 root     root          4096 Nov 24  2021 mnt
drwxr-xr-x    2 root     root          4096 Apr  9 07:37 multitool
drwxr-xr-x    2 root     root          4096 Nov 24  2021 opt
dr-xr-xr-x  254 root     root             0 Apr  9 07:37 proc
drwx------    2 root     root          4096 Nov 24  2021 root
drwxr-xr-x    1 root     root          4096 Apr  9 07:37 run
drwxr-xr-x    1 root     root          4096 Dec 19  2021 sbin
drwxr-xr-x    2 root     root          4096 Nov 24  2021 srv
dr-xr-xr-x   13 root     root             0 Apr  9 07:37 sys
drwxrwxrwt    2 root     root          4096 Nov 24  2021 tmp
drwxr-xr-x    1 root     root          4096 Dec 19  2021 usr
drwxr-xr-x    1 root     root          4096 Dec 19  2021 var
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitool-845d8cf967-w5qj7 -c multitool -- ls -la /multitool
total 12
drwxr-xr-x    2 root     root          4096 Apr  9 07:37 .
drwxr-xr-x    1 root     root          4096 Apr  9 07:37 ..
-rw-r--r--    1 root     root           105 Apr  9 07:40 file.txt
```

4. Продемонстрировать, что multitool может читать файл, который периодоически обновляется.  
```bash
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitool-845d8cf967-w5qj7 -c multitool -- cat /multitool/file.txt
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
Write!
```
![image](https://user-images.githubusercontent.com/99823951/230762150-0a5d4c1d-c6ec-4459-aa06-c0d9e0d06087.png)

5. Предоставить манифесты Deployment в решении, а также скриншоты или вывод команды из п. 4.

------

### Задание 2

**Что нужно сделать**

Создать DaemonSet приложения, которое может прочитать логи ноды.

1. Создать DaemonSet приложения, состоящего из multitool.  
Создал [DaemonSet](https://github.com/AlekseyDrobnyi/netology_devops/blob/main/13.1/yml/daemosetMultitool.yaml)  
```bash
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl apply -f daemosetMultitool.yaml
daemonset.apps/multitooldaemonset configured
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl get all
NAME                           READY   STATUS    RESTARTS   AGE
pod/multitooldaemonset-k2dcm   1/1     Running   0          8s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.152.183.1   <none>        443/TCP   7d20h

NAME                                DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/multitooldaemonset   1         1         1       1            1           <none>          11m
```
2. Обеспечить возможность чтения файла `/var/log/syslog` кластера MicroK8S.  
За это будет отвечать `volum` :
```bash 
    hostPath:
    path: /var/log
```
3. Продемонстрировать возможность чтения файла изнутри пода.  
Проверяю путь 
```bash
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitooldaemonset-k2dcm -- ls -la
total 84
drwxr-xr-x    1 root     root          4096 Apr  9 08:07 .
drwxr-xr-x    1 root     root          4096 Apr  9 08:07 ..
drwxr-xr-x    1 root     root          4096 Dec 19  2021 bin
drwx------    2 root     root          4096 Dec 19  2021 certs
drwxr-xr-x    5 root     root           360 Apr  9 08:07 dev
drwxr-xr-x    1 root     root          4096 Dec 19  2021 docker
drwxr-xr-x    1 root     root          4096 Apr  9 08:07 etc
drwxr-xr-x    2 root     root          4096 Nov 24  2021 home
drwxr-xr-x    1 root     root          4096 Dec 19  2021 lib
drwxr-xr-x    5 root     root          4096 Nov 24  2021 media
drwxr-xr-x    2 root     root          4096 Nov 24  2021 mnt
drwxrwxr-x   12 root     113           4096 Apr  9 00:00 multitool
drwxr-xr-x    2 root     root          4096 Nov 24  2021 opt
dr-xr-xr-x  251 root     root             0 Apr  9 08:07 proc
drwx------    2 root     root          4096 Nov 24  2021 root
drwxr-xr-x    1 root     root          4096 Apr  9 08:07 run
drwxr-xr-x    1 root     root          4096 Dec 19  2021 sbin
drwxr-xr-x    2 root     root          4096 Nov 24  2021 srv
dr-xr-xr-x   13 root     root             0 Apr  9 08:07 sys
drwxrwxrwt    2 root     root          4096 Nov 24  2021 tmp
drwxr-xr-x    1 root     root          4096 Dec 19  2021 usr
drwxr-xr-x    1 root     root          4096 Dec 19  2021 var
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitooldaemonset-k2dcm -- ls -la /multitool
total 5976
drwxrwxr-x   12 root     113           4096 Apr  9 00:00 .
drwxr-xr-x    1 root     root          4096 Apr  9 08:07 ..
-rw-r--r--    1 root     root             0 Apr  7 00:00 alternatives.log
-rw-r--r--    1 root     root          6676 Apr  6 06:15 alternatives.log.1
drwxr-xr-x    2 root     root          4096 Apr  7 00:00 apt
-rw-r-----    1 107      adm          16621 Apr  9 07:17 auth.log
-rw-r-----    1 107      adm        1088046 Apr  8 23:44 auth.log.1
-rw-r-----    1 107      adm           5297 Apr  1 23:57 auth.log.2.gz
-rw-rw----    1 root     43          432768 Apr  9 05:27 btmp
-rw-rw----    1 root     43               0 Apr  1 11:26 btmp.1
drwxr-xr-x    3 root     root          4096 Apr  1 11:28 calico
-rw-r-----    1 root     adm           5014 Apr  1 11:26 cloud-init-output.log
-rw-r--r--    1 107      adm         133407 Apr  1 11:26 cloud-init.log
drwxr-xr-x    2 root     root          4096 Apr  9 08:07 containers
drwxr-xr-x    2 root     root          4096 Apr 18  2022 dist-upgrade
-rw-r-----    1 root     adm          77325 Apr  1 11:26 dmesg
-rw-r--r--    1 root     root             0 Apr  7 00:00 dpkg.log
-rw-r--r--    1 root     root          4062 Apr  6 06:15 dpkg.log.1
drwxr-x---    3 root     adm           4096 Mar 29 10:06 installer
drwxr-sr-x    4 root     nginx         4096 Apr  1 11:26 journal
-rw-r-----    1 107      adm           2754 Apr  9 08:07 kern.log
-rw-r-----    1 107      adm           7825 Apr  2 19:25 kern.log.1
-rw-r-----    1 107      adm          21423 Apr  1 20:11 kern.log.2.gz
drwxr-xr-x    2 111      117           4096 Apr  1 11:26 landscape
-rw-rw-r--    1 root     43          292292 Apr  2 18:54 lastlog
drwxr-xr-x    7 root     root          4096 Apr  9 08:07 pods
drwx------    2 root     root          4096 Apr 21  2022 private
-rw-r-----    1 107      adm         650519 Apr  9 08:08 syslog
-rw-r-----    1 107      adm        2828915 Apr  9 00:00 syslog.1
-rw-r-----    1 107      adm         709877 Apr  2 00:00 syslog.2.gz
-rw-r--r--    1 root     root          6670 Apr  9 02:16 ubuntu-advantage-timer.log
-rw-r--r--    1 root     root          6245 Apr  8 05:36 ubuntu-advantage.log
-rw-r--r--    1 root     root          1603 Apr  1 14:12 ubuntu-advantage.log.1
drwxr-x---    2 root     adm           4096 Apr  7 00:00 unattended-upgrades
-rw-rw-r--    1 root     43            5376 Apr  2 18:55 wtmp
```
Все успешно, логи ноды читаются в файле `syslog`
```bash
ubuntu@ubuntu-VirtualBox:~/.kube$ kubectl exec multitooldaemonset-k2dcm -- cat /multitool/syslog
Apr  9 00:00:06 k8s systemd[1]: rsyslog.service: Sent signal SIGHUP to main process 826 (rsyslogd) on client request.
Apr  9 00:00:06 k8s systemd[1]: logrotate.service: Deactivated successfully.
Apr  9 00:00:06 k8s systemd[1]: Finished Rotate log files.
Apr  9 00:00:46 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.6SABC2.mount: Deactivated successfully.
Apr  9 00:01:22 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.IeBDMi.mount: Deactivated successfully.
Apr  9 00:06:25 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.e5DIyM.mount: Deactivated successfully.
Apr  9 00:09:14 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.bcFZvt.mount: Deactivated successfully.
Apr  9 00:14:24 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.RvBwoG.mount: Deactivated successfully.
Apr  9 00:17:01 k8s CRON[3512166]: (root) CMD (   cd / && run-parts --report /etc/cron.hourly)
Apr  9 00:17:54 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.AZh0Vk.mount: Deactivated successfully.
Apr  9 00:18:05 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.Ehiy2i.mount: Deactivated successfully.
Apr  9 00:18:32 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.UMUge1.mount: Deactivated successfully.
Apr  9 00:21:34 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.oXo7Xo.mount: Deactivated successfully.
Apr  9 00:23:22 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.OOa3ae.mount: Deactivated successfully.
Apr  9 00:27:35 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.wEyhNR.mount: Deactivated successfully.
Apr  9 00:29:56 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.tWKJgm.mount: Deactivated successfully.
Apr  9 00:30:25 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.0VgPyG.mount: Deactivated successfully.
Apr  9 00:33:03 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.FjEPD3.mount: Deactivated successfully.
Apr  9 00:34:35 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.xN33p9.mount: Deactivated successfully.
Apr  9 00:40:44 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.X5dOV9.mount: Deactivated successfully.
Apr  9 00:42:34 k8s systemd[1]: run-containerd-runc-k8s.io-d1489aa8e9cdfec543e8d3e49358a66a43d5c1a3713d7d3a48ead6ba912d6a50-runc.y2xfnD.mount: Deactivated successfully.
Apr  9 00:44:35 k8s systemd[1]: run-containerd-runc-k8s.io-17ceaf850c8ef7c447fa1ceabdc2250d66c9b57f847bbfe69a7b04844898d5c7-runc.iNkCp7.mount: Deactivated successfully.
..............................................
```
4. Предоставить манифесты Deployment, а также скриншоты или вывод команды из п. 2.

------

### Правила приёма работы

1. Домашняя работа оформляется в своём Git-репозитории в файле README.md. Выполненное задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд `kubectl`, а также скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.

------
